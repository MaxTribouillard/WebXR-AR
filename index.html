<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebXR AR Test</title>
    <script src="https://cdn.jsdelivr.net/npm/babylonjs@8.38.0/babylon.min.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@zappar/zappar-babylonjs-es6@4.1.0/lib/src/babylon.min.js"></script>
    <script src="zappar/zappar-babylon.js"></script>
</head>
<body>
    <canvas id="renderCanvas" style="width:100%; height:100vh;"></canvas>

    <script>

        const canvasHolder = document.querySelector('#canvas-holder') || document.createElement('div');
        const canvas = document.createElement('canvas');
        canvasHolder.appendChild(canvas);

        const engine = new BABYLON.Engine(canvas, true, { preserveDrawingBuffer: true, stencil: true });
        const scene = new BABYLON.Scene(engine);
        const light = new BABYLON.HemisphericLight('light1', new BABYLON.Vector3(0, 1, 0), scene);


        const camera = new ZapparBabylon.Camera('camera', scene);
        // camera.setCameraPoseMode(ZapparBabylon.CameraPoseMode.Attitude);

        ZapparBabylon.permissionRequestUI().then(granted => {
            if (granted) {
                // User granted the permissions so start the camera
                camera.start();
            } else {
                // User denied the permissions so show Zappar's built-in 'permission denied' UI
                ZapparBabylon.permissionDeniedUI();
            }
        });

        const instantWorldTracker = new ZapparBabylon.InstantWorldTracker();
        instantWorldTracker.setAnchorPoseFromCameraOffset(0, 0, -5);
        const trackerTransformNode = new ZapparBabylon.InstantWorldAnchorTransformNode('tracker', camera, instantWorldTracker, scene);

        // --- CHARGER LE GLB (méthode moderne) ---
        const loadModel = async () => {
            const container = await SceneLoader.LoadAssetContainerAsync(
                "",             // chemin ou "" si root
                "model.glb",     // ton fichier glb
                scene
            );

            // Ajout au tracker Zappar (AR)
            container.meshes.forEach(m => m.parent = trackerTransformNode);

            // Ajout de tout le container à la scène
            container.addAllToScene();
        };

        loadModel();

        engine.runRenderLoop(() => {
            camera.updateFrame();
            instantWorldTracker.setAnchorPoseFromCameraOffset(0, 0, -5);
            scene.render();
        });

    </script>
</body>
</html>